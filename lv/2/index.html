<!doctype html>
<meta charset="utf-8" />
<title>Verifying…</title>
<style>
  body{margin:0;font-family:Inter,system-ui,Arial;background:#0b1220;color:#e8ecf4;display:grid;place-items:center;min-height:100svh}
  .card{background:#131b2c;border-radius:14px;padding:22px;max-width:560px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .muted{color:#9aa3b2}
</style>
<div class="card">
  <div id="msg">Verifying step 2…</div>
  <div class="muted" id="sub"></div>
</div>
<script>
(async function(){
  const u  = new URL(location.href);
  const hw = u.searchParams.get('hwid') || '';
  const h  = u.searchParams.get('hash') || '';

  if (!h || h.length !== 64){
    msg.textContent = 'Missing Linkvertise hash.'; sub.textContent = 'Open the link again from the portal.'; return;
  }

  try{
    const r = await fetch('/.netlify/functions/lv-verify', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ hash: h })
    });
    const d = await r.json();
    if (d.ok && d.valid){
      try{ localStorage.setItem('lv2','1'); }catch(_){}
      const qs = hw ? ('?hwid='+encodeURIComponent(hw)) : '';
      location.replace('/'+qs);
    } else {
      msg.textContent = 'Verification failed (step 2).';
      sub.textContent = d.error || d.reason || 'Try again.';
    }
  }catch(e){
    msg.textContent = 'Network error.'; sub.textContent = String(e);
  }
})();
</script>
