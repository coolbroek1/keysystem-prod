<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Key Portal</title>
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
  <style>
    :root{
      --bg:#0b1220; --card:#131b2c; --cardTop:#121a2b; --muted:#9aa3b2; --text:#e8ecf4;
      --line:#1e2a44; --accent:#0bd28a; --blue:#3a56f0; --green:#1aaf66; --danger:#e25555;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:Inter, system-ui, Arial; color:var(--text); background:linear-gradient(180deg,#0b1220,#0b1220 60%,#0e1628); min-height:100vh}
    .wrap{max-width:1080px; margin:80px auto; padding:0 18px}
    .card{background:var(--card); border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.35); overflow:hidden}
    .head{padding:20px 22px; background:var(--cardTop); display:flex; align-items:center; justify-content:space-between; gap:12px}
    h1{font-size:18px; margin:0}
    .muted{color:var(--muted); font-size:13px}
    .keyrow{padding:22px}
    .key{font-family:ui-monospace, Menlo, Consolas; padding:10px 12px; background:#0f1726; border-radius:10px; display:inline-block; word-break:break-all}
    .pill{padding:6px 10px; background:rgba(46,204,113,.15); color:#56e39f; border-radius:999px; font-size:12px; margin-left:10px}
    .barwrap{display:flex; align-items:center; gap:16px}
    .barlbl{min-width:70px}
    .bar{height:6px; width:180px; background:#0f1726; border-radius:999px; overflow:hidden}
    .bar>span{display:block; height:100%; width:0%; background:var(--accent); transition:width .25s ease}
    .footer{display:flex; justify-content:space-between; align-items:center; gap:16px; padding:22px; border-top:1px solid var(--line); flex-wrap:wrap}
    .btn{padding:10px 16px; border-radius:10px; border:1px solid #2a3553; cursor:pointer; background:#182139; color:#dfe7ff; font-weight:600; transition:transform .08s ease, filter .2s ease}
    .btn:hover{filter:brightness(1.1)}
    .btn:active{transform:translateY(1px)}
    .btn.green{background:var(--green); border-color:var(--green); color:#fff}
    .btn.blue{background:var(--blue); border-color:var(--blue); color:#fff}
    .btn[disabled]{opacity:.5; cursor:not-allowed}
    .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    .hint{font-size:12px; color:var(--muted)}
    .brand{font-size:12px; color:#8ad2ff}
    .danger{background:rgba(255,107,107,.15); color:#ff8c8c; border-radius:10px; padding:10px 12px; margin-top:10px; display:none}
    /* overlay */
    .overlay{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(2,6,20,.6); backdrop-filter:blur(2px); z-index:9999}
    .sheet{background:#121a2b; border:1px solid #283455; padding:18px 20px; border-radius:14px; box-shadow:0 10px 30px rgba(0,0,0,.45); display:flex; align-items:center; gap:12px}
    .spinner{width:18px; height:18px; border-radius:50%; border:3px solid #2b3a60; border-top-color:#5f8cff; animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .copybtn{margin-left:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="head">
        <div>
          <h1>Key</h1>
          <div class="barwrap">
            <div class="muted barlbl">Progress: <span id="progLabel">0/2</span></div>
            <div class="bar"><span id="progBar"></span></div>
          </div>
        </div>
        <button id="btnStart" class="btn green">⎘ START</button>
      </div>

      <div class="keyrow">
        <div id="keyRow" class="muted">No key yet. Finish both steps and click <b>Get Key</b>.</div>
        <div id="bypassMsg" class="danger">Bypass detected. Please complete Linkvertise normally.</div>
      </div>

      <div class="footer">
        <div class="row">
          <div id="cf" class="cf-turnstile" data-sitekey="0x4AAAAAABqkj0VWX1D2cl4e" data-callback="onTurnstile"></div>
          <button id="btnGet" class="btn blue" disabled>Get Key</button>
          <div class="hint" id="hint">by Ezyscript❤️</div>
        </div>
      </div>
    </div>
  </div>

  <!-- loading overlay -->
  <div id="overlay" class="overlay" role="dialog" aria-live="polite">
    <div class="sheet"><div class="spinner"></div><div id="ovText">Generating key…</div></div>
  </div>

<script>
/*** CONFIG ***/
const PROXY   = "/.netlify/functions/keyproxy";
const LVVERIFY= "/.netlify/functions/lv-verify";
const STEP1   = "https://link-hub.net/1380626/oXYyD2XlP2qW";
const STEP2   = "https://link-hub.net/1380626/bouVTQdnXmmi";

/*** STATE ***/
let token = null;
window.onTurnstile = t => { token = t; refresh(); };

/*** LOCAL STORAGE HELPERS ***/
function setLv(n){ localStorage.setItem('lv'+n, '1'); }
function clearLv(){ ['lv1','lv2'].forEach(k=>localStorage.removeItem(k)); }
function flags(){ return { s1: localStorage.getItem('lv1')==='1', s2: localStorage.getItem('lv2')==='1' }; }
function getActive(){ const k=localStorage.getItem('activeKey'); const e=Number(localStorage.getItem('activeKeyExp')||0); if(!k||!e||Date.now()>e) return null; return {key:k,expiresAt:e}; }
function setActive(k){ if(!k){localStorage.removeItem('activeKey');localStorage.removeItem('activeKeyExp');return;} localStorage.setItem('activeKey',k.key); localStorage.setItem('activeKeyExp',String(k.expiresAt)); }
function clearAllLocal(keepHWID=true){
  setActive(null);
  clearLv();
  if(!keepHWID) localStorage.removeItem('hwid');
}

/*** UI HELPERS ***/
function fmtLeft(exp){ const ms=Math.max(0,exp-Date.now()); const h=Math.floor(ms/3.6e6),m=Math.floor((ms%3.6e6)/6e4); return `${h}h ${m}m`; }
function renderKeyCard(k){
  const row=document.getElementById('keyRow');
  if(!k){ row.innerHTML='No key yet. Finish both steps and click <b>Get Key</b>.'; return;}
  const left=fmtLeft(k.expiresAt);
  row.innerHTML = `<span class="key">${k.key}</span><span class="pill">Active · ${left} left</span> <button id="copyBtn" class="btn copybtn">Copy</button>`;
  document.getElementById('copyBtn').onclick=()=>navigator.clipboard.writeText(k.key);
}
function refresh(){
  const { s1,s2 } = flags();
  const prog=(s1?1:0)+(s2?1:0);
  document.getElementById('progLabel').textContent = `${prog}/2`;
  document.getElementById('progBar').style.width = `${(prog/2)*100}%`;
  const hasActive = !!getActive();
  const cfOk = !!token;
  document.getElementById('btnGet').disabled = hasActive || !(s1&&s2&&cfOk);
  document.getElementById('hint').textContent = cfOk ? 'by Ezyscript❤️' : 'Complete Turnstile (disable adblock if needed)';
}
function showOverlay(t){ const o=document.getElementById('overlay'); document.getElementById('ovText').textContent=t||'Working…'; o.style.display='flex'; }
function hideOverlay(){ document.getElementById('overlay').style.display='none'; }

/*** SERVER SYNC — do NOT clear 1/2–2/2 here ***/
async function syncWithServer(){
  const hwid = localStorage.getItem('hwid');
  if (!hwid) return;
  try{
    const r = await fetch(PROXY,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ action:'lookup_active_key', hwid }) });
    const d = await r.json();
    if (d.ok && d.key){
      const local = getActive();
      if (!local || local.key !== d.key || local.expiresAt !== d.expiresAt){
        const k = { key:d.key, expiresAt:d.expiresAt };
        setActive(k); renderKeyCard(k);
      }
    } else {
      setActive(null);
      renderKeyCard(null);
    }
    refresh();
  }catch(_){}
}

/*** ANTI-BYPASS fallback (?step=&hash=…) ***/
async function maybeVerifyInIndex(){
  const u = new URL(location.href);
  const step = u.searchParams.get('step');
  const hash = u.searchParams.get('hash');
  const hwid = u.searchParams.get('hwid');
  const purge = u.searchParams.get('purge');
  if (hwid) localStorage.setItem('hwid', hwid);
  if (purge==='1'){ clearAllLocal(); history.replaceState({}, '', '/'); refresh(); return; }

  if (!step || !hash) return;
  try{
    const ref = document.referrer || '';
    const r = await fetch(LVVERIFY,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ step:String(step), hash:String(hash), hwid, ref }) });
    const d = await r.json();
    if (d && d.ok){
      if (step==='1') setLv(1);
      if (step==='2') setLv(2);
      history.replaceState({}, '', '/'); refresh();
    } else {
      const el=document.getElementById('bypassMsg'); el.style.display='inline-block';
      history.replaceState({}, '', '/'); refresh();
      setTimeout(()=>{ el.style.display='none'; }, 2500);
    }
  }catch(_){}
}

/*** INIT ***/
(async function init(){
  // hwid from URL
  const url = new URL(location.href);
  const hwid = url.searchParams.get('hwid');
  if (hwid) localStorage.setItem('hwid', hwid);

  const local = getActive();
  if (local) renderKeyCard(local);
  refresh();

  await maybeVerifyInIndex();   // handle /?step=&hash=
  await syncWithServer();       // align key only
})();

/*** ACTIONS ***/
document.getElementById('btnStart').onclick = () => {
  const { s1,s2 } = flags();
  window.open(s1 ? STEP2 : STEP1, '_blank');
};

document.getElementById('btnGet').onclick = async () => {
  const hwid = localStorage.getItem('hwid') || prompt('Enter your HWID (from Roblox):'); if (!hwid) return;
  try{
    showOverlay('Generating key…');
    document.getElementById('btnGet').disabled=true;
    const r = await fetch(PROXY,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ action:'request_key', hwid, turnstileToken: token })
    });
    const d = await r.json();
    if(d.ok&&d.key){
      const k={key:d.key, expiresAt:d.expiresAt};
      setActive(k); renderKeyCard(k); refresh();
    } else {
      alert('Error: '+(d.error||'unknown'));
      setActive(null); renderKeyCard(null); refresh();
    }
  } finally {
    document.getElementById('btnGet').disabled=false;
    hideOverlay();
  }
};
</script>
</body>
</html>
