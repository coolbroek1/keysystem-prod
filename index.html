<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Key Portal</title>
<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
<style>
:root{--bg:#0b1220;--card:#131b2c;--cardTop:#121a2b;--muted:#9aa3b2;--text:#e8ecf4;--line:#1e2a44;--accent:#0bd28a;--blue:#3a56f0;--green:#1aaf66}
*{box-sizing:border-box}body{margin:0;font-family:Inter,system-ui,Arial;color:var(--text);background:linear-gradient(180deg,#0b1220,#0b1220 60%,#0e1628);min-height:100vh}
.wrap{max-width:1080px;margin:80px auto;padding:0 18px}
.card{background:var(--card);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35);overflow:hidden}
.head{padding:20px 22px;background:var(--cardTop);display:flex;align-items:center;justify-content:space-between;gap:12px}
h1{font-size:18px;margin:0}.muted{color:var(--muted);font-size:13px}
.keyrow{padding:22px}.key{font-family:ui-monospace,Menlo,Consolas;padding:10px 12px;background:#0f1726;border-radius:10px;display:inline-block;word-break:break-all}
.pill{padding:6px 10px;background:rgba(46,204,113,.15);color:#56e39f;border-radius:999px;font-size:12px;margin-left:10px}
.barwrap{display:flex;align-items:center;gap:12px;flex-wrap:wrap}.barlbl{min-width:90px}
.bar{height:6px;width:220px;background:#0f1726;border-radius:999px;overflow:hidden}.bar>span{display:block;height:100%;width:0%;background:var(--accent)}
.footer{display:flex;justify-content:space-between;align-items:center;gap:16px;padding:22px;border-top:1px solid var(--line);flex-wrap:wrap}
.btn{padding:10px 16px;border-radius:10px;border:1px solid #2a3553;cursor:pointer;background:#182139;color:#dfe7ff;font-weight:600}
.btn.green{background:var(--green);border-color:var(--green);color:#fff}.btn.blue{background:var(--blue);border-color:var(--blue);color:#fff}
.btn[disabled]{opacity:.6;cursor:not-allowed}.row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.hint{font-size:12px;color:var(--muted)}.brand{font-size:12px;color:#8ad2ff}
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:50}
.modal .box{background:#131b2c;border:1px solid #283455;padding:18px 22px;border-radius:12px;min-width:240px;text-align:center}
.alert{color:#ff8c8c;font-size:12px;margin-left:10px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="head">
      <div>
        <h1>Key</h1>
        <div class="barwrap">
          <div class="muted barlbl">Progress: <span id="progLabel">0/2</span><span id="bypass" class="alert"></span></div>
          <div class="bar"><span id="progBar"></span></div>
        </div>
      </div>
      <button id="btnStart" class="btn green">⎘ START</button>
    </div>
    <div class="keyrow"><div id="keyRow" class="muted">No key yet. Finish both steps and click <b>Get Key</b>.</div></div>
    <div class="footer">
      <div class="row">
        <div id="cf" class="cf-turnstile" data-sitekey="0x4AAAAAABqkj0VWX1D2cl4e" data-callback="onTurnstile"></div>
        <button id="btnGet" class="btn blue" disabled>Get Key</button>
        <div class="hint" id="hint">by Ezyscript❤️</div>
      </div>
    </div>
  </div>
</div>
<div id="wait" class="modal"><div class="box"><div style="font-weight:700;margin-bottom:6px">Generating key…</div><div class="muted">Please wait a moment.</div></div></div>

<script>
/*** CONFIG — open real Linkvertise pages on START ***/
const STEP1 = "https://link-hub.net/1380626/oXYyD2XlP2qW";
const STEP2 = "https://link-hub.net/1380626/bouVTQdnXmmi";
const PROXY = "/.netlify/functions/keyproxy";

/*** TURNSTILE ***/
let token = null; window.onTurnstile = t => { token = t; update(); };

/*** HWID helpers ***/
function getHWID(){ return localStorage.getItem('hwid') || ""; }
function setHWID(h){ if(h) localStorage.setItem('hwid', h); }

/*** Bootstrap (capture hwid or bypass flag on return) ***/
(function(){
  const u = new URL(location.href);
  const hwid = u.searchParams.get('hwid');
  const bypass = u.searchParams.get('bypass');
  if (hwid) setHWID(hwid);
  if (bypass==='1') document.getElementById('bypass').textContent = 'Bypass detected';
  if (hwid || bypass) history.replaceState({}, '', '/');
})();

/*** UI helpers ***/
function renderKeyCard(k){
  const row=document.getElementById('keyRow');
  if(!k){ row.innerHTML='No key yet. Finish both steps and click <b>Get Key</b>.'; return;}
  const ms = Math.max(0, k.expiresAt-Date.now());
  const left = `${Math.floor(ms/3.6e6)}h ${Math.floor((ms%3.6e6)/6e4)}m`;
  row.innerHTML = `<span class="key">${k.key}</span><span class="pill">Active · ${left} left</span> <button id="copyBtn" class="btn" style="margin-left:10px">Copy</button>`;
  const c=document.getElementById('copyBtn'); c && (c.onclick=()=>navigator.clipboard.writeText(k.key));
}
function setProgress(p){
  const done=(p.s1?1:0)+(p.s2?1:0);
  document.getElementById('progLabel').textContent = `${done}/2`;
  document.getElementById('progBar').style.width = `${(done/2)*100}%`;
  document.getElementById('btnGet').disabled = !(p.s1 && p.s2 && !!token);
}

/*** Server calls ***/
async function fetchProgress(){
  const hwid = getHWID(); if(!hwid) return {s1:false,s2:false};
  const r = await fetch(PROXY,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'progress_get',hwid:hwid})});
  const d = await r.json(); return d.ok ? {s1:!!d.s1,s2:!!d.s2} : {s1:false,s2:false};
}
async function fetchActiveFromServer(){
  const hwid = getHWID(); if(!hwid) return null;
  const r = await fetch(PROXY,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'lookup_active_key',hwid:hwid})});
  const d = await r.json(); if(d.ok&&d.key) return {key:d.key, expiresAt:d.expiresAt}; return null;
}

/*** Update whole UI ***/
async function update(){
  const p = await fetchProgress(); setProgress(p);
  const k = await fetchActiveFromServer(); if (k) renderKeyCard(k);
}

/*** START → open real Linkvertise (server will mark when it returns to /lv/1 or /lv/2) ***/
document.getElementById('btnStart').onclick = async () => {
  const p = await fetchProgress();
  const target = (!p.s1 ? STEP1 : STEP2);
  const hw = getHWID() || prompt('Enter your HWID (from Roblox):'); if(!hw) return;
  setHWID(hw);
  window.open(target, '_blank');
};

/*** GET KEY with “Generating…” modal ***/
const wait = document.getElementById('wait');
document.getElementById('btnGet').onclick = async () => {
  const hwid = getHWID() || prompt('Enter your HWID (from Roblox):'); if (!hwid) return;
  try{
    wait.style.display='flex';
    document.getElementById('btnGet').disabled=true;
    const r = await fetch(PROXY,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ action:'request_key', hwid:hwid, turnstileToken: token })});
    const d = await r.json();
    if(d.ok&&d.key){ renderKeyCard({key:d.key, expiresAt:d.expiresAt}); }
    else alert('Error: '+(d.error||'unknown'));
    await update();
  } finally { document.getElementById('btnGet').disabled=false; wait.style.display='none'; }
};

// Refresh UI whenever you come back from Linkvertise tab
window.addEventListener('focus', update);
update();
</script>
</body>
</html>
