<script>
const PROXY = "/.netlify/functions/keyproxy";
const DEVISSUE = "/.netlify/functions/dev-issue";
const STEP1 = "https://link-hub.net/1380626/oXYyD2XlP2qW";
const STEP2 = "https://link-hub.net/1380626/bouVTQdnXmmi";

let token = null;
window.onTurnstile = t => { token = t; refresh(); };

// flags
function setLv(n){ localStorage.setItem('lv'+n,'1'); }
function clearLv(){ ['lv1','lv2'].forEach(k=>localStorage.removeItem(k)); }
function flags(){ return { s1: localStorage.getItem('lv1')==='1', s2: localStorage.getItem('lv2')==='1' }; }

// capture ?lv & ?hwid & ?reset
(function(){
  const u = new URL(location.href);
  const lv=u.searchParams.get('lv'); const reset=u.searchParams.get('reset'); const hwid=u.searchParams.get('hwid');
  if (lv==='1') setLv(1); if (lv==='2') setLv(2);
  if (hwid) localStorage.setItem('hwid', hwid);
  if (reset==='1'){ localStorage.removeItem('activeKey'); localStorage.removeItem('activeKeyExp'); clearLv(); }
  if (lv || hwid || reset) history.replaceState({},'', '/');
})();

function getActive(){
  const k = localStorage.getItem('activeKey'); const e = Number(localStorage.getItem('activeKeyExp')||0);
  if (!k||!e||Date.now()>e) return null; return {key:k,expiresAt:e};
}
function setActive(k){
  if(!k){ localStorage.removeItem('activeKey'); localStorage.removeItem('activeKeyExp'); return; }
  localStorage.setItem('activeKey', k.key);
  localStorage.setItem('activeKeyExp', String(k.expiresAt));
}
function fmtLeft(exp){ const ms=Math.max(0,exp-Date.now()); const h=Math.floor(ms/3.6e6), m=Math.floor((ms%3.6e6)/6e4); return `${h}h ${m}m`; }
function renderKeyCard(k){
  const row=document.getElementById('keyRow');
  if(!k){ row.innerHTML='Nog geen key. Rond beide stappen af en klik <b>Get Key</b>.'; return; }
  row.innerHTML=`<span class="key">${k.key}</span><span class="pill">Active · ${fmtLeft(k.expiresAt)} left</span> <button id="copyBtn" class="btn" style="margin-left:10px">Copy</button>`;
  document.getElementById('copyBtn').onclick=()=>navigator.clipboard.writeText(k.key);
}

// extra: ALTIJD met server synchroniseren
async function syncWithServer(){
  const hwid = localStorage.getItem('hwid'); if(!hwid) return;
  try{
    const r = await fetch(PROXY,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'lookup_active_key', hwid})});
    const d = await r.json();
    if (d.ok && d.key){
      const local = getActive();
      if (!local || local.key!==d.key || local.expiresAt!==d.expiresAt){
        const k={key:d.key, expiresAt:d.expiresAt}; setActive(k); renderKeyCard(k);
      }
    } else {
      // server zegt: geen geldige key -> wis lokale cache + progress
      setActive(null); clearLv(); renderKeyCard(null);
    }
  }catch(_){}
}

function refresh(){
  const {s1,s2}=flags(); const prog=(s1 and 1 or 0)+(s2 and 1 or 0);
  document.getElementById('progLabel').textContent = `${(s1?1:0)+(s2?1:0)}/2`;
  document.getElementById('progBar').style.width = `${(((s1 and 1 or 0)+(s2 and 1 or 0))/2)*100}%`;
  const hasActive = !!getActive();
  document.getElementById('btnGet').disabled = hasActive || !(s1&&s2&&!!token);
  document.getElementById('hint').textContent = !hasActive && !(s1&&s2) ? 'Voltooi beide stappen; als je terugkomt via /lv/1 en /lv/2 wordt dit automatisch 2/2.' : '';
}

document.getElementById('btnStart').onclick = () => { const {s1,s2}=flags(); window.open(s1?STEP2:STEP1,'_blank'); };

document.getElementById('btnGet').onclick = async () => {
  const hwid = localStorage.getItem('hwid') || prompt('Enter your HWID (from Roblox):'); if (!hwid) return;
  try{
    document.getElementById('btnGet').disabled=true;
    const r = await fetch(PROXY,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ action:'request_key', hwid, turnstileToken: token })});
    const d = await r.json();
    if(d.ok&&d.key){ const k={key:d.key, expiresAt:d.expiresAt}; setActive(k); renderKeyCard(k); refresh(); }
    else alert('Error: '+(d.error||'unknown'));
  } finally { document.getElementById('btnGet').disabled=false; }
};

// DEV (optioneel): blijft zoals jij ‘m hebt of via /Admin gebruiken

// init: eerst render wat we hebben, daarna ALTIJD sync met server
(function init(){
  const local = getActive(); renderKeyCard(local); refresh(); syncWithServer();
})();
</script>
