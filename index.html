<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Key Portal · Ezyscript</title>
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
  <style>
    :root{
      --bg:#0b1220; --card:#131b2c; --cardTop:#121a2b; --muted:#9aa3b2; --text:#e8ecf4;
      --line:#1e2a44; --accent:#0bd28a; --blue:#3a56f0; --green:#1aaf66;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:Inter, system-ui, Arial; color:var(--text); background:linear-gradient(180deg,#0b1220,#0b1220 60%,#0e1628); min-height:100vh}
    a{color:inherit}
    .wrap{max-width:1080px; margin:80px auto; padding:0 20px}
    .card{background:var(--card); border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.35); overflow:hidden}
    .card-top{padding:24px; background:var(--cardTop); display:flex; align-items:center; gap:16px; justify-content:space-between}
    .title{display:flex; align-items:center; gap:12px; font-weight:800; font-size:20px}
    .badge{font-size:12px; color:#9aa3b2}
    .right{display:flex; align-items:center; gap:20px}
    .muted{color:var(--muted); font-size:14px}
    .row{display:flex; align-items:center; gap:12px}
    .bar{height:6px; background:#0f1726; border-radius:999px; overflow:hidden}
    .bar>span{display:block; height:100%; width:0%; background:var(--accent)}
    .keycard{padding:22px;}
    .key{font-family:ui-monospace, Menlo, Consolas; padding:10px 12px; background:#0f1726; border-radius:10px; display:inline-block; word-break:break-all}
    .pill{padding:6px 10px; background:rgba(46,204,113,.15); color:#56e39f; border-radius:999px; font-size:12px; margin-left:10px}
    .footer{display:flex; justify-content:space-between; align-items:center; gap:16px; padding:22px; border-top:1px solid var(--line); flex-wrap:wrap}
    .btn{padding:10px 16px; border-radius:10px; border:1px solid #2a3553; cursor:pointer; background:#182139; color:#dfe7ff; font-weight:700; transition:transform .06s ease}
    .btn:active{transform:scale(.98)}
    .btn.green{background:var(--green); border-color:var(--green); color:#fff}
    .btn.blue{background:var(--blue); border-color:var(--blue); color:#fff}
    .btn[disabled]{opacity:.5; cursor:not-allowed}
    .dev{display:none; align-items:center; gap:10px; flex-wrap:wrap}
    .dev.show{display:flex}
    .hint{font-size:12px; color:var(--muted)}
    .copy{padding:8px 10px; border-radius:8px; border:1px solid #2a3553; background:#0f1726; color:#dfe7ff; min-width:240px}
    .copy:focus{outline:none}
    .copy-row{display:flex; align-items:center; gap:10px}
    .tagline{padding:10px 22px; color:#9aa3b2; font-size:13px; border-top:1px solid #0e1730; background:#0f1726}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="card-top">
        <div class="title">
          Key
          <span class="badge">by Ezyscript❤️</span>
        </div>
        <div class="right">
          <div class="muted">
            Progress:
            <div class="bar" style="width:220px;margin-top:6px">
              <span id="progBar"></span>
            </div>
            <div style="text-align:right;margin-top:4px"><span id="progLabel">0/2</span></div>
          </div>
          <button id="btnStart" class="btn green">Get link</button>
        </div>
      </div>

      <div class="keycard">
        <div id="keyRow" class="muted">No key yet. Finish both steps and press <b>Get Key</b>.</div>
      </div>

      <div class="footer">
        <div class="row">
          <div id="cf" class="cf-turnstile" data-sitekey="0x4AAAAAABqkj0VWX1D2cl4e" data-callback="onTurnstile"></div>
          <button id="btnGet" class="btn blue" disabled>Get Key</button>
          <div class="hint" id="hint"></div>
        </div>

        <!-- DEV bar (toggle with Alt+D or add ?dev=1 to URL) -->
        <div id="devbar" class="dev">
          <input id="devHwid" placeholder="HWID (optional)" class="copy" />
          <button id="btnDev" class="btn">DEV: Quick Key</button>
          <div id="devStatus" class="hint"></div>
        </div>
      </div>

      <div class="tagline">Tip: Press <b>Alt + D</b> to show/hide the developer bar.</div>
    </div>
  </div>

<script>
/* ------------------- constants ------------------- */
const PROXY   = "/.netlify/functions/keyproxy";
const DEVISSUE= "/.netlify/functions/dev-issue"; // optional; uses server ADMIN_SECRET
const STEP1   = "https://link-hub.net/1380626/oXYyD2XlP2qW";
const STEP2   = "https://link-hub.net/1380626/bouVTQdnXmmi";

let token = null;
window.onTurnstile = t => { token = t; refresh(); };

/* ------------------- absorb Linkvertise return (supports ?step=1&hash=..., ?lv=1, /lv/1) ------------------- */
(async function absorbLV(){
  try{
    const url  = new URL(location.href);
    const step = url.searchParams.get('step') || url.searchParams.get('lv') ||
                 ((location.pathname.match(/\/lv\/(1|2)\/?$/) || [])[1]);
    const hash = url.searchParams.get('hash');
    const hwid = url.searchParams.get('hwid');
    if (hwid) localStorage.setItem('hwid', hwid);

    if (step && hash) {
      // Anti-bypass check on server (lv-verify must exist)
      try{
        const r = await fetch('/.netlify/functions/lv-verify',{
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ step, hash })
        });
        const d = await r.json();
        if (d.ok) localStorage.setItem(step === '1' ? 'lv1' : 'lv2', '1');
      }catch(_){}
    } else if (step) {
      // Fallback if provider doesn’t send a hash
      localStorage.setItem(step === '1' ? 'lv1' : 'lv2', '1');
    }

    if (step || hash || hwid) history.replaceState({}, '', '/');
  }catch(_){}
})();

/* ------------------- progress helpers ------------------- */
function setLv(n){ localStorage.setItem('lv'+n, '1'); }
function getFlags(){ return { s1: localStorage.getItem('lv1')==='1', s2: localStorage.getItem('lv2')==='1' }; }

/* ------------------- key persistence ------------------- */
function getActive(){
  const k = localStorage.getItem('activeKey');
  const e = Number(localStorage.getItem('activeKeyExp') || 0);
  if (!k || !e || Date.now()>e) return null;
  return { key:k, expiresAt:e };
}
function setActive(k){
  if(!k){ localStorage.removeItem('activeKey'); localStorage.removeItem('activeKeyExp'); return; }
  localStorage.setItem('activeKey', k.key);
  localStorage.setItem('activeKeyExp', String(k.expiresAt));
}

/* ------------------- UI renderers ------------------- */
function fmtLeft(exp){
  const ms = Math.max(0, exp-Date.now());
  const h=Math.floor(ms/3.6e6), m=Math.floor((ms%3.6e6)/6e4);
  return `${h}h ${m}m`;
}
function renderKeyCard(k){
  const row = document.getElementById('keyRow');
  if(!k){
    row.innerHTML = 'No key yet. Finish both steps and press <b>Get Key</b>.';
    return;
  }
  const left = fmtLeft(k.expiresAt);
  row.innerHTML =
    `<span class="key">${k.key}</span>`+
    `<span class="pill">Active · ${left} left</span>`+
    ` <button id="copyBtn" class="btn" style="margin-left:10px">Copy</button>`;
  const btn = document.getElementById('copyBtn');
  btn.onclick = async () => { try{ await navigator.clipboard.writeText(k.key); btn.textContent='Copied!'; setTimeout(()=>btn.textContent='Copy',1200);}catch(_){ alert('Clipboard unavailable, copy manually.'); } };
}

function refresh(){
  const { s1, s2 } = getFlags();
  const prog = (s1?1:0) + (s2?1:0);
  document.getElementById('progLabel').textContent = `${prog}/2`;
  document.getElementById('progBar').style.width = `${(prog/2)*100}%`;
  const hasActive = !!getActive();
  const cfOk = !!token;
  document.getElementById('btnGet').disabled = hasActive || !(s1 && s2 && cfOk);
  document.getElementById('hint').textContent = cfOk ? '' : 'Complete the Turnstile check first.';
}

/* ------------------- dev bar toggle ------------------- */
window.addEventListener('keydown', (e)=>{
  if (e.altKey && (e.key==='d' || e.key==='D')){
    const v = localStorage.getItem('dev')==='1' ? '0' : '1';
    localStorage.setItem('dev', v);
    document.getElementById('devbar').classList.toggle('show', v==='1');
  }
});
if (new URL(location.href).searchParams.get('dev')==='1') localStorage.setItem('dev','1');
document.getElementById('devbar').classList.toggle('show', localStorage.getItem('dev')==='1');

/* ------------------- init: restore key or fetch from server ------------------- */
async function lookupFromServer(){
  const hwid = localStorage.getItem('hwid'); if(!hwid) return null;
  try{
    const r = await fetch(PROXY,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ action:'lookup_active_key', hwid }) });
    const d = await r.json();
    if (d.ok && d.key) return { key:d.key, expiresAt:d.expiresAt };
  }catch(_){}
  return null;
}
(async function init(){
  const local = getActive();
  if (local) renderKeyCard(local);
  else {
    const srv = await lookupFromServer();
    if (srv){ setActive(srv); renderKeyCard(srv); }
  }
  refresh();
})();

/* ------------------- actions ------------------- */
const btnStart = document.getElementById('btnStart');
btnStart.onclick = () => {
  const { s1, s2 } = getFlags();
  window.open(s1 ? STEP2 : STEP1, '_blank');
};

const btnGet = document.getElementById('btnGet');
btnGet.onclick = async () => {
  const hwid = localStorage.getItem('hwid') || prompt('Enter your HWID (from Roblox):');
  if (!hwid) return;
  try{
    btnGet.disabled = true;
    const r = await fetch(PROXY,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ action:'request_key', hwid, turnstileToken: token })
    });
    const d = await r.json();
    if (d.ok && d.key){
      const k = { key:d.key, expiresAt:d.expiresAt };
      setActive(k); renderKeyCard(k); refresh();
    } else {
      alert('Error: '+(d.error||'unknown'));
    }
  } finally { btnGet.disabled = false; }
};

/* DEV quick key (same site). Requires server ADMIN_SECRET; otherwise it will return an error. */
const devStatus = document.getElementById('devStatus');
const btnDev = document.getElementById('btnDev');
btnDev.onclick = async () => {
  const hwid = document.getElementById('devHwid').value.trim() || localStorage.getItem('hwid') || prompt('HWID?');
  if(!hwid) return;
  try{
    btnDev.disabled = true; devStatus.textContent = 'Requesting key...';
    const r = await fetch(DEVISSUE,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ hwid }) });
    const d = await r.json();
    if (d.ok && d.key){
      const k = { key:d.key, expiresAt:d.expiresAt };
      setActive(k); renderKeyCard(k); refresh();
      devStatus.textContent = 'Issued.';
    } else {
      devStatus.textContent = 'Dev error: '+(d.error||'unknown');
    }
  } catch(e){ devStatus.textContent = 'Network error.'; }
  finally{ btnDev.disabled=false; }
};
</script>
</body>
</html>
