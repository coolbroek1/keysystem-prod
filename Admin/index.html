<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin</title>
  <style>
    body{margin:0;font-family:Inter,system-ui,Arial;background:#0b1220;color:#e8ecf4}
    .wrap{max-width:900px;margin:60px auto;padding:0 20px}
    .card{background:#131b2c;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35);overflow:hidden}
    .head{padding:18px 22px;background:#121a2b;font-weight:700}
    .row{padding:20px;border-top:1px solid #1e2a44}
    .grid{display:grid;grid-template-columns:160px 1fr auto;gap:10px;align-items:center}
    input,button{padding:10px 12px;border-radius:10px;border:1px solid #2a3553;background:#0f1726;color:#dfe7ff;font-size:14px}
    button{cursor:pointer;background:#3a56f0}
    button.green{background:#1aaf66}
    button.red{background:#c24141}
    code{background:#0f1726;padding:6px 8px;border-radius:8px}
    .muted{color:#9aa3b2}
    #login{max-width:420px;margin:60px auto}
  </style>
</head>
<body>
<div id="login" class="wrap" style="display:none">
  <div class="card">
    <div class="head">Admin login</div>
    <div class="row">
      <div class="grid">
        <label>Wachtwoord</label>
        <input id="pw" type="password" placeholder="••••" />
        <button id="btnLogin">Login</button>
      </div>
      <div class="muted" style="margin-top:10px">Voor nu: <b>aze</b></div>
    </div>
  </div>
</div>

<div id="app" class="wrap" style="display:none">
  <div class="card">
    <div class="head">Key Admin</div>

    <div class="row grid">
      <label>HWID</label>
      <input id="hwid" placeholder="B1532DAA-03EE-42B8-AAEE-905CDCBE7B02" />
      <span></span>
    </div>

    <div class="row grid">
      <label>Lookup active</label>
      <button id="btnLookup">Lookup</button>
      <span id="lkOut" class="muted"></span>
    </div>

    <div class="row grid">
      <label>Issue new key</label>
      <button class="green" id="btnIssue">Issue</button>
      <span id="ikOut" class="muted"></span>
    </div>

    <div class="row grid">
      <label>Reset HWID</label>
      <button class="red" id="btnReset">Reset</button>
      <span id="rsOut" class="muted"></span>
    </div>

    <div class="row">
      <div class="muted">Tip: Forceer client refresh: <code>/?reset=1&amp;hwid=&lt;HWID&gt;</code></div>
    </div>
  </div>
</div>

<script>
const PROXY    = "/.netlify/functions/keyproxy";
const DEVISSUE = "/.netlify/functions/dev-issue";
const ADMIN_PW = "aze";

const fmtBE = (ms) =>
  new Intl.DateTimeFormat('nl-BE', {
    timeZone: 'Europe/Brussels',
    year:'numeric', month:'2-digit', day:'2-digit',
    hour:'2-digit', minute:'2-digit', hour12:false
  }).format(new Date(ms));

function $(id){ return document.getElementById(id); }

function showApp(v){
  $('login').style.display = v ? 'none':'block';
  $('app').style.display   = v ? 'block':'none';
}
(function boot(){
  const ok = sessionStorage.getItem('adm_ok')==='1';
  showApp(ok);
})();

$('btnLogin').onclick = ()=>{
  if ($('pw').value === ADMIN_PW){
    sessionStorage.setItem('adm_ok','1'); showApp(true);
  } else { alert('Fout wachtwoord'); }
};

$('btnLookup').onclick = async ()=>{
  const hwid = $('hwid').value.trim(); if(!hwid) return;
  $('lkOut').textContent = 'Bezig...';
  try{
    const r = await fetch(PROXY,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'lookup_active_key', hwid})});
    const d = await r.json();
    if (d.ok){
      $('lkOut').innerHTML = `Key: <code>${d.key}</code> &nbsp; Expires: <b>${fmtBE(d.expiresAt)}</b>`;
    } else {
      $('lkOut').textContent = d.error || 'not_found';
    }
  }catch(e){ $('lkOut').textContent = String(e); }
};

$('btnIssue').onclick = async ()=>{
  const hwid = $('hwid').value.trim(); if(!hwid) return;
  $('ikOut').textContent = 'Bezig key uitgeven...';
  try{
    const r = await fetch(DEVISSUE,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ hwid })});
    const d = await r.json();
    if (d.ok){
      $('ikOut').innerHTML = `Nieuwe key: <code>${d.key}</code> &nbsp; Expires: <b>${fmtBE(d.expiresAt)}</b>`;
    } else {
      $('ikOut').textContent = d.error || 'error';
    }
  }catch(e){ $('ikOut').textContent = String(e); }
};

$('btnReset').onclick = async ()=>{
  const hwid = $('hwid').value.trim(); if(!hwid) return;
  $('rsOut').textContent = 'Bezig reset...';
  try{
    // server-side reset (Apps Script) via keyproxy
    const r = await fetch(PROXY,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'admin_reset_hwid', adminSecret:'aze', hwid})});
    const d = await r.json();
    if (d.ok){
      $('rsOut').innerHTML = `OK — verwijderde keys: <b>${d.deleted||0}</b>. <a href="/?reset=1&hwid=${encodeURIComponent(hwid)}" target="_blank">Open client (force reset)</a>`;
    } else {
      $('rsOut').textContent = d.error || 'error';
    }
  }catch(e){ $('rsOut').textContent = String(e); }
};
</script>
</body>
</html>
