<!-- (Gebruik je huidige Admin HTML; vervang alleen de <script> met dit) -->
<script>
const PROXY    = "/.netlify/functions/keyproxy";
const ADMINAPI = "/.netlify/functions/admin-api";
const fmt = new Intl.DateTimeFormat('en-GB',{ timeZone:'Europe/Brussels', year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' });

let authed = false;
login.onclick = () => {
  authed = (pw.value === 'aze');
  panel.style.display = authed ? 'block' : 'none';
};

function show(o){
  if (!o) { out.innerHTML = ''; return; }
  if (o.ok && o.key) {
    out.textContent = `OK
key: ${o.key}
expires: ${fmt.format(new Date(o.expiresAt))}`;
  } else if (o.ok && typeof o.removed === 'number') {
    const h = (hwid.value||'').trim();
    const portal = `https://timely-biscochitos-88e2f6.netlify.app/?hwid=${encodeURIComponent(h)}`;
    const purge  = `${portal}&purge=1`;
    out.innerHTML = `OK â€” removed ${o.removed} keys
\nSend this to user to clear local flags:
${purge}
\nPortal (no purge):
${portal}
\n<button id="cp1">Copy purge link</button> <button id="cp2">Copy portal link</button>`;
    setTimeout(()=>{
      const cp1 = document.getElementById('cp1');
      const cp2 = document.getElementById('cp2');
      cp1 && (cp1.onclick = ()=>navigator.clipboard.writeText(purge));
      cp2 && (cp2.onclick = ()=>navigator.clipboard.writeText(portal));
    }, 0);
  } else {
    out.textContent = JSON.stringify(o, null, 2);
  }
}

lookup.onclick = async () => {
  const h = hwid.value.trim(); if(!h) return;
  const r = await fetch(PROXY,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'lookup_active_key',hwid:h})});
  show(await r.json());
};

issue.onclick = async () => {
  const h = hwid.value.trim(); if(!h) return;
  const r = await fetch(ADMINAPI,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'admin_issue_key',hwid:h,pass:'aze'})});
  show(await r.json());
};

reset.onclick = async () => {
  const h = hwid.value.trim(); if(!h) return;
  const r = await fetch(ADMINAPI,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'admin_reset_hwid_and_purge',hwid:h,pass:'aze'})});
  show(await r.json());
};
</script>
