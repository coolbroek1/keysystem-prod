<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin</title>
<style>
  :root{ --bg:#0b1220; --card:#121a2b; --line:#243153; --text:#e8ecf4; --muted:#9aa3b2; --blue:#3a56f0; --green:#1aaf66; --red:#d9534f }
  *{box-sizing:border-box}
  body{margin:0; font-family:Inter, system-ui, Arial; color:var(--text); background:linear-gradient(180deg,#0b1220,#0e1628)}
  .wrap{max-width:880px; margin:60px auto; padding:0 18px}
  .card{background:var(--card); border:1px solid var(--line); border-radius:14px; padding:18px 18px 8px}
  h1{margin:0 0 14px 0; font-size:20px}
  .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin:8px 0}
  input,button{padding:10px 12px; border-radius:10px; border:1px solid var(--line); background:#0f1726; color:#dfe7ff}
  button{cursor:pointer; background:#182139}
  button.blue{background:var(--blue); border-color:var(--blue)}
  button.green{background:var(--green); border-color:var(--green)}
  button.red{background:#9b2c2c; border-color:#9b2c2c}
  .muted{color:var(--muted); font-size:13px}
  .out{background:#0f1726; padding:10px; border-radius:10px; font:12px ui-monospace,Menlo,Consolas; word-break:break-all}
  .login{max-width:360px; margin:100px auto; text-align:center}
  .hidden{display:none}
</style>
</head>
<body>
<div class="wrap">
  <div id="login" class="login">
    <h1>Admin</h1>
    <div class="row"><input id="pw" type="password" placeholder="Password" style="width:100%"></div>
    <div class="row"><button id="enter" class="blue" style="width:100%">Enter</button></div>
    <div class="muted">Hint: youknow</div>
  </div>

  <div id="app" class="hidden">
    <div class="card">
      <h1>Actions</h1>
      <div class="row"><input id="hwid" placeholder="HWID" style="min-width:280px; flex:1"></div>
      <div class="row">
        <button id="lookup" class="blue">Lookup Active</button>
        <button id="issue"  class="green">Issue Key</button>
        <button id="reset"  class="red">Reset HWID (revoke)</button>
      </div>
      <div class="muted">Times are Europe/Brussels.</div>
      <div id="out" class="out" style="margin-top:10px"></div>
    </div>
  </div>
</div>

<script>
const PROXY    = "/.netlify/functions/keyproxy";
const DEVISSUE = "/.netlify/functions/dev-issue"; // uses server ADMIN_SECRET
const TZ_FMT = new Intl.DateTimeFormat('en-GB',{ timeZone:'Europe/Brussels', year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' });

function log(o){ const el = document.getElementById('out'); el.innerText = typeof o==='string'? o : JSON.stringify(o,null,2); }
function pingPortal(type){ try{ localStorage.setItem('serverChange', JSON.stringify({ ts: Date.now(), type: type||'reset' })); }catch(_){ } }

/* login */
enter.onclick = () => {
  if (pw.value.trim() === 'aze'){ login.classList.add('hidden'); app.classList.remove('hidden'); }
  else alert('Wrong password.');
};

/* lookup */
lookup.onclick = async () => {
  const hwid = document.getElementById('hwid').value.trim(); if(!hwid) return alert('Enter HWID');
  try{
    log('Loading…');
    const r = await fetch(PROXY,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ action:'lookup_active_key', hwid }) });
    const d = await r.json();
    if(d.ok){
      log({ ok:true, key:d.key, expiresAt: d.expiresAt, expiresLocal: TZ_FMT.format(new Date(d.expiresAt)) });
    }else{
      log(d);
    }
  }catch(e){ log(String(e)); }
};

/* issue new key (revokes old on server; portal wordt via ping gereset) */
issue.onclick = async () => {
  const hwid = document.getElementById('hwid').value.trim(); if(!hwid) return alert('Enter HWID');
  try{
    log('Issuing…');
    const r = await fetch(DEVISSUE,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ hwid }) });
    const d = await r.json();
    if(d.ok){
      log({ ok:true, key:d.key, expiresAt: d.expiresAt, expiresLocal: TZ_FMT.format(new Date(d.expiresAt)) });
      pingPortal('reset'); // portal: clear key+progress, resync
    }else{
      log(d);
    }
  }catch(e){ log(String(e)); }
};

/* reset HWID (revoke mapping) — requires Apps Script action admin_reset_hwid */
reset.onclick = async () => {
  const hwid = document.getElementById('hwid').value.trim(); if(!hwid) return alert('Enter HWID');
  try{
    log('Resetting…');
    const r = await fetch(PROXY,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ action:'admin_reset_hwid', hwid, adminSecret:'aze' }) });
    const d = await r.json();
    log(d);
    if(d.ok){ pingPortal('reset'); } // portal: clear key+progress, resync
  }catch(e){ log(String(e)); }
};
</script>
</body>
</html>
